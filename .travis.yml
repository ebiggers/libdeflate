language: c
os: linux
dist: focal
compiler:
  - gcc
  - clang
env:
  global:
    - CFLAGS=-Werror
arch:
  - amd64
  - arm64
  - ppc64le
  - s390x
before_install: sudo apt-get install -y libz-dev valgrind
script: scripts/run_tests.sh

# Additional jobs not generated by the above build matrix:
jobs:
  include:
    # Jobs to test older Ubuntu distros.  Ideally these would be generated by
    # the build matrix, but Travis CI doesn't support expanding by 'dist'...

    - dist: precise
      compiler: gcc
      arch: amd64

    - dist: precise
      compiler: clang
      arch: amd64

    - dist: xenial
      compiler: gcc
      arch: amd64

    - dist: xenial
      compiler: clang
      arch: amd64

    - dist: xenial
      compiler: gcc
      arch: arm64
      # Ignore incorrect -Wstrict-aliasing warning in adler32_neon_chunk(),
      # not seen with any other compiler versions.
      env: CFLAGS="-Wno-strict-aliasing -Werror"

    - dist: xenial
      compiler: clang
      arch: arm64
      # ASAN fails with internal error
      env: DISABLE_ASAN=1

    - dist: xenial
      compiler: gcc
      arch: ppc64le
      # ASAN fails with internal error
      env: DISABLE_ASAN=1

    - dist: xenial
      compiler: clang
      arch: ppc64le
      # ASAN fails with internal error
      env: DISABLE_ASAN=1

    - dist: xenial
      compiler: gcc
      arch: s390x

    - dist: xenial
      compiler: clang
      arch: s390x

    # Other Linux jobs

    - name: clang static analyzer
      before_install: sudo apt-get install -y clang
      script: make scan-build

    - name: shellcheck
      before_install: sudo apt-get install -y shellcheck
      script: make shellcheck

    - name: Cross compile for Windows
      before_install:
        - sudo apt-get install -y gcc-mingw-w64-x86-64 libz-mingw-w64-dev
      script:
        - make CC=i686-w64-mingw32-gcc all test_programs
        - make CC=x86_64-w64-mingw32-gcc all test_programs

    # Non-Linux jobs

    - name: macOS, xcode11
      os: osx
      osx_image: xcode11
      before_install:
      script: make all check

    - name: macOS, xcode9.4
      os: osx
      osx_image: xcode9.4
      before_install:
      script: make all check

    - name: macOS, xcode7.3
      os: osx
      osx_image: xcode7.3
      before_install:
      script: make all check

    - name: Windows, MinGW
      os: windows
      before_install:
      script: mingw32-make all check
