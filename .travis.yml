language: c

env:
  global:
    - CFLAGS=-Werror

matrix:
  include:
    - name: Native tests (Linux)
      os: linux
      dist: bionic
      before_install:
        - sudo apt-get install -y libz-dev gcc-multilib libz-dev:i386
          libc6-dev-i386 valgrind clang gcc-4.8-multilib gcc-mingw-w64-i686
      script:
        - scripts/run_tests.sh native freestanding

    - name: clang static analyzer
      os: linux
      dist: bionic
      before_install:
        - sudo apt-get install -y clang
      script:
        - make scan-build

    - name: Native tests (Linux aarch64)
      os: linux
      dist: bionic
      arch: arm64
      before_install:
        - sudo apt-get install -y libz-dev valgrind clang
      script:
        - scripts/run_tests.sh native freestanding

    - name: gzip and cross-compile-for-Windows tests (Linux)
      os: linux
      dist: bionic
      before_install:
        - sudo apt-get install -y libz-dev valgrind
          gcc-mingw-w64-x86-64 libz-mingw-w64-dev
      script:
        - scripts/run_tests.sh gzip windows

    - name: Basic tests (old Linux distro, gcc)
      os: linux
      dist: precise
      compiler: gcc
      script:
        - make all check

    - name: Basic tests (old Linux distro, clang)
      os: linux
      dist: precise
      compiler: clang
      script:
        - make all check

    - name: Basic tests (macOS, xcode11)
      os: osx
      osx_image: xcode11
      script:
        - make all check

    - name: Basic tests (macOS, xcode9.4)
      os: osx
      osx_image: xcode9.4
      script:
        - make all check

    - name: Basic tests (macOS, xcode7.3)
      os: osx
      osx_image: xcode7.3
      script:
        - make all check

    - name: Basic tests (Windows, MinGW)
      os: windows
      script:
        - mingw32-make all check

    - name: Native tests (Linux s390x)
      os: linux
      dist: bionic
      arch: s390x
      before_install:
        - sudo apt-get install -y libz-dev valgrind clang
      script:
        - scripts/run_tests.sh native freestanding
